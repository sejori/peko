"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["vendors-node_modules_github_alive-client_dist_index_js-node_modules_github_memoize_dist_esm_i-fab77c"],{27907(a,b,c){c.d(b,{a:()=>AliveSession});var d,e,f=c(81855),g=c(60835),h=c(16544),i=c(75658),j=c(80955),k=c(29871);(e=d||(d={})).Deploy="Alive Redeploy",e.Reconnect="Alive Reconnect";class AliveSession{constructor(a,b,c,d){this.url=a,this.getUrl=b,this.inSharedWorker=c,this.notify=d,this.subscriptions=new i.v,this.state="online",this.retrying=null,this.connectionCount=0,this.presence=new f.k2,this.presenceMetadata=new g.a,this.intentionallyDisconnected=!1,this.lastCameOnline=0,this.userId=function(a){let b=a.match(/\/u\/(\d+)\/ws/);return b?+b[1]:0}(a),this.presenceId=`${Math.round(2147483647*Math.random())}_${Math.round(Date.now()/1e3)}`,this.presenceKey=(0,f.Hw)(this.userId,this.presenceId),this.socket=this.connect()}subscribe(a){let b=this.subscriptions.add(...a);for(let c of(this.sendSubscribe(b),a)){let d=c.topic.name;(0,f.A)(d)&&this.notifyCachedPresence(c.subscriber,d)}}unsubscribe(a){let b=this.subscriptions.delete(...a);this.sendUnsubscribe(b)}unsubscribeAll(...a){let b=this.subscriptions.drain(...a);this.sendUnsubscribe(b);let c=this.presenceMetadata.removeSubscribers(a);this.sendPresenceMetadataUpdate(c)}requestPresence(a,b){for(let c of b)this.notifyCachedPresence(a,c)}notifyCachedPresence(a,b){let c=this.presence.getChannelItems(b);0!==c.length&&this.notifyPresenceChannel(b,c)}updatePresenceMetadata(a){let b=new Set;for(let c of a)this.presenceMetadata.setMetadata(c),b.add(c.channelName);this.sendPresenceMetadataUpdate(b)}sendPresenceMetadataUpdate(a){if(!a.size)return;let b=[];for(let c of a){let d=this.subscriptions.topic(c);d&&b.push(d)}this.sendSubscribe(b)}online(){var a;this.lastCameOnline=Date.now(),this.state="online",null===(a=this.retrying)|| void 0===a||a.abort(),this.socket.open()}offline(){var a;this.state="offline",null===(a=this.retrying)|| void 0===a||a.abort(),this.socket.close()}shutdown(){this.inSharedWorker&&self.close()}get reconnectWindow(){let a=Date.now()-this.lastCameOnline<6e4;return 0===this.connectionCount||this.intentionallyDisconnected||a?0:1e4}socketDidOpen(){this.intentionallyDisconnected=!1,this.connectionCount++,this.socket.url=this.getUrlWithPresenceId(),this.sendSubscribe(this.subscriptions.topics())}socketDidClose(a,b,c){if(void 0!==this.redeployEarlyReconnectTimeout&&clearTimeout(this.redeployEarlyReconnectTimeout),"Alive Reconnect"===c)this.intentionallyDisconnected=!0;else if("Alive Redeploy"===c){this.intentionallyDisconnected=!0;let d=3+22*Math.random(),e=6e4*d;this.redeployEarlyReconnectTimeout=setTimeout(()=>{this.intentionallyDisconnected=!0,this.socket.close(1e3,"Alive Redeploy Early Client Reconnect")},e)}}socketDidFinish(){"offline"!==this.state&&this.reconnect()}socketDidReceiveMessage(a,b){let c=JSON.parse(b);switch(c.e){case"ack":this.handleAck(c);break;case"msg":this.handleMessage(c)}}handleAck(a){for(let b of this.subscriptions.topics())b.offset=a.off}handleMessage(a){let b=a.ch,c=this.subscriptions.topic(b);if(c){if(c.offset=a.off,"e"in a.data){let d=this.presence.handleMessage(b,a.data);this.notifyPresenceChannel(b,d);return}a.data.wait||(a.data.wait=0),this.notify(this.subscriptions.subscribers(b),{channel:b,type:"message",data:a.data})}}notifyPresenceChannel(a,b){var c,d;let e=new Map;for(let f of b){let{userId:h,metadata:i,presenceKey:j}=f,k=e.get(h)||{userId:h,isOwnUser:h===this.userId,metadata:[]};if(j!==this.presenceKey){for(let l of i){if(g.Z in l){!1!==k.isIdle&&(k.isIdle=Boolean(l[g.Z]));continue}k.metadata.push(l)}e.set(h,k)}}for(let m of this.subscriptions.subscribers(a)){let n=this.userId,o=Array.from(e.values()).filter(a=>a.userId!==n),p=null!==(d=null===(c=e.get(this.userId))|| void 0===c?void 0:c.metadata)&& void 0!==d?d:[],q=this.presenceMetadata.getChannelMetadata(a,{subscriber:m,markAllAsLocal:!this.inSharedWorker});this.notify([m],{channel:a,type:"presence",data:[{userId:n,isOwnUser:!0,metadata:[...p,...q]},...o]})}}async reconnect(){if(!this.retrying)try{this.retrying=new AbortController;let a=await (0,k.X)(this.getUrl,1/0,6e4,this.retrying.signal);a?(this.url=a,this.socket=this.connect()):this.shutdown()}catch(b){if("AbortError"!==b.name)throw b}finally{this.retrying=null}}getUrlWithPresenceId(){let a=new URL(this.url,self.location.origin);return a.searchParams.set("shared",this.inSharedWorker.toString()),a.searchParams.set("p",`${this.presenceId}.${this.connectionCount}`),a.toString()}connect(){let a=new h.Oo(this.getUrlWithPresenceId(),this,{timeout:4e3,attempts:7});return a.open(),a}sendSubscribe(a){let b=Array.from(a);for(let c of(0,j.o)(b,25)){let d={};for(let e of c)(0,f.A)(e.name)?d[e.signed]=JSON.stringify(this.presenceMetadata.getChannelMetadata(e.name)):d[e.signed]=e.offset;this.socket.send(JSON.stringify({subscribe:d}))}}sendUnsubscribe(a){let b=Array.from(a,a=>a.signed);for(let c of(0,j.o)(b,25))this.socket.send(JSON.stringify({unsubscribe:c}));for(let d of a)(0,f.A)(d.name)&&this.presence.clearChannel(d.name)}}},29871(a,b,c){function d(a){return new Promise((b,c)=>{let d=Error("aborted");d.name="AbortError",a.aborted?c(d):a.addEventListener("abort",()=>c(d))})}async function e(a,b){let c,e=new Promise(b=>{c=self.setTimeout(b,a)});if(!b)return e;try{await Promise.race([e,d(b)])}catch(f){throw self.clearTimeout(c),f}}function f(a){return Math.floor(Math.random()*Math.floor(a))}async function g(a,b,c=1/0,g){let h=g?d(g):null;for(let i=0;i<b;i++)try{let j=h?Promise.race([a(),h]):a();return await j}catch(k){if("AbortError"===k.name||i===b-1)throw k;let l=1e3*Math.pow(2,i),m=f(.1*l);await e(Math.min(c,l+m),g)}throw Error("retry failed")}c.d(b,{X:()=>g})},21461(a,b,c){c.d(b,{A:()=>f.A,ZE:()=>e.Z,Zf:()=>h.Z,a2:()=>d.a,ah:()=>e.a,vk:()=>g.v});var d=c(27907),e=c(60835),f=c(81855),g=c(75658),h=c(72993)},80955(a,b,c){c.d(b,{o:()=>d});function*d(a,b){for(let c=0;c<a.length;c+=b)yield a.slice(c,c+b)}},60835(a,b,c){c.d(b,{Z:()=>d,a:()=>PresenceMetadataSet});let d="_i";function e(a){return Object.assign(Object.assign({},a),{isLocal:!0})}class PresenceMetadataForChannel{constructor(){this.subscriberMetadata=new Map}setMetadata(a,b){this.subscriberMetadata.set(a,b)}removeSubscribers(a){let b=!1;for(let c of a)b=this.subscriberMetadata.delete(c)||b;return b}getMetadata(a){if(!a){let b=[],c;for(let f of this.subscriberMetadata.values())for(let g of f)if(d in g){let h=Boolean(g[d]);c=void 0===c?h:h&&c}else b.push(g);return void 0!==c&&b.push({[d]:c?1:0}),b}let i=[],{subscriber:j,markAllAsLocal:k}=a;for(let[l,m]of this.subscriberMetadata){let n=k||l===j,o=n?m.map(e):m;i.push(...o)}return i}hasSubscribers(){return this.subscriberMetadata.size>0}}class PresenceMetadataSet{constructor(){this.metadataByChannel=new Map}setMetadata({subscriber:a,channelName:b,metadata:c}){let d=this.metadataByChannel.get(b);d||(d=new PresenceMetadataForChannel,this.metadataByChannel.set(b,d)),d.setMetadata(a,c)}removeSubscribers(a){let b=new Set;for(let[c,d]of this.metadataByChannel){let e=d.removeSubscribers(a);e&&b.add(c),d.hasSubscribers()||this.metadataByChannel.delete(c)}return b}getChannelMetadata(a,b){let c=this.metadataByChannel.get(a);return(null==c?void 0:c.getMetadata(b))||[]}}},81855(a,b,c){function d(a,b){return`${a}:${b}`}function e(a){let[b,c]=a.p.split(".");return{userId:a.u,presenceKey:d(a.u,b),connectionCount:Number(c),metadata:a.m||[]}}function f(a){return a.startsWith("presence-")}c.d(b,{A:()=>f,Hw:()=>d,k2:()=>AlivePresence});class PresenceChannel{constructor(){this.presenceItems=new Map}shouldUsePresenceItem(a){let b=this.presenceItems.get(a.presenceKey);return!b||b.connectionCount<=a.connectionCount}addPresenceItem(a){this.shouldUsePresenceItem(a)&&this.presenceItems.set(a.presenceKey,a)}removePresenceItem(a){this.shouldUsePresenceItem(a)&&this.presenceItems.delete(a.presenceKey)}replacePresenceItems(a){for(let b of(this.presenceItems.clear(),a))this.addPresenceItem(b)}getPresenceItems(){return Array.from(this.presenceItems.values())}}class AlivePresence{constructor(){this.presenceChannels=new Map}getPresenceChannel(a){let b=this.presenceChannels.get(a)||new PresenceChannel;return this.presenceChannels.set(a,b),b}handleMessage(a,b){let c=this.getPresenceChannel(a);switch(b.e){case"pf":c.replacePresenceItems(b.d.map(e));break;case"pa":c.addPresenceItem(e(b.d));break;case"pr":c.removePresenceItem(e(b.d))}return this.getChannelItems(a)}getChannelItems(a){let b=this.getPresenceChannel(a);return b.getPresenceItems()}clearChannel(a){this.presenceChannels.delete(a)}}},75658(a,b,c){c.d(b,{v:()=>SubscriptionSet});var d=c(61268);class SubscriptionSet{constructor(){this.subscriptions=new d.Z,this.signatures=new Map}add(...a){let b=[];for(let{subscriber:c,topic:d}of a)this.subscriptions.has(d.name)||(b.push(d),this.signatures.set(d.name,d)),this.subscriptions.set(d.name,c);return b}delete(...a){let b=[];for(let{subscriber:c,topic:d}of a){let e=this.subscriptions.delete(d.name,c);e&&!this.subscriptions.has(d.name)&&(b.push(d),this.signatures.delete(d.name))}return b}drain(...a){let b=[];for(let c of a)for(let d of this.subscriptions.drain(c)){let e=this.signatures.get(d);this.signatures.delete(d),b.push(e)}return b}topics(){return this.signatures.values()}topic(a){return this.signatures.get(a)||null}subscribers(a){return this.subscriptions.get(a).values()}}},72993(a,b,c){c.d(b,{Z:()=>Topic});class Topic{constructor(a,b){this.name=a,this.signed=b,this.offset=""}static parse(a){let[b,c]=a.split("--");if(!b||!c)return null;let d=JSON.parse(atob(b));return d.c&&d.t?new Topic(d.c,a):null}}},15205(a,b,c){function d(...a){return JSON.stringify(a,(a,b)=>"object"==typeof b?b:String(b))}function e(a,b={}){let{hash:c=d,cache:e=new Map}=b;return function(...b){let d=c.apply(this,b);if(e.has(d))return e.get(d);let f=a.apply(this,b);return f instanceof Promise&&(f=f.catch(a=>{throw e.delete(d),a})),e.set(d,f),f}}c.d(b,{Z:()=>e})},61268(a,b,c){c.d(b,{Z:()=>MultiMap});class MultiMap{constructor(a){if(this.map=new Map,a)for(let[b,c]of a)this.set(b,c)}get(a){let b=this.map.get(a);return b||new Set}set(a,b){let c=this.map.get(a);return c||(c=new Set,this.map.set(a,c)),c.add(b),this}has(a){return this.map.has(a)}delete(a,b){let c=this.map.get(a);if(!c)return!1;if(!b)return this.map.delete(a);let d=c.delete(b);return c.size||this.map.delete(a),d}drain(a){let b=[];for(let c of this.keys())this.delete(c,a)&&!this.has(c)&&b.push(c);return b}keys(){return this.map.keys()}values(){return this.map.values()}entries(){return this.map.entries()}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}get size(){return this.map.size}}},16544(a,b,c){async function d(a,b){let c,d=new Promise((b,d)=>{c=self.setTimeout(()=>d(Error("timeout")),a)});if(!b)return d;try{await Promise.race([d,g(b)])}catch(e){throw self.clearTimeout(c),e}}async function e(a,b){let c,d=new Promise(b=>{c=self.setTimeout(b,a)});if(!b)return d;try{await Promise.race([d,g(b)])}catch(e){throw self.clearTimeout(c),e}}async function f(a,b,c=1/0,d){let f=d?g(d):null;for(let i=0;i<b;i++)try{let j=f?Promise.race([a(),f]):a();return await j}catch(k){if("AbortError"===k.name||i===b-1)throw k;let l=1e3*Math.pow(2,i),m=h(.1*l);await e(Math.min(c,l+m),d)}throw Error("retry failed")}function g(a){return new Promise((b,c)=>{let d=Error("aborted");d.name="AbortError",a.aborted?c(d):a.addEventListener("abort",()=>c(d))})}function h(a){return Math.floor(Math.random()*Math.floor(a))}async function i(a,b,c){let e=new WebSocket(a),f=k(e);try{return await Promise.race([f,d(b,c)]),e}catch(g){throw j(f),g}}async function j(a){try{let b=await a;b.close()}catch(c){}}function k(a){return new Promise((b,c)=>{a.readyState===WebSocket.OPEN?b(a):(a.onerror=()=>{a.onerror=null,a.onopen=null,c(Error("connect failed"))},a.onopen=()=>{a.onerror=null,a.onopen=null,b(a)})})}c.d(b,{Oo:()=>StableSocket});class StableSocket{constructor(a,b,c){this.socket=null,this.opening=null,this.url=a,this.delegate=b,this.policy=c}async open(){if(this.opening||this.socket)return;this.opening=new AbortController;let a=Object.assign(Object.assign({},this.policy),{signal:this.opening.signal});try{var b,c;this.socket=await (b=this.url,c=a,f(()=>i(b,c.timeout,c.signal),c.attempts,c.maxDelay,c.signal))}catch(d){this.delegate.socketDidFinish(this);return}finally{this.opening=null}this.socket.onclose=a=>{this.socket=null,this.delegate.socketDidClose(this,a.code,a.reason);let b=this.delegate.socketShouldRetry?!this.delegate.socketShouldRetry(this,a.code):m(a.code);b?this.delegate.socketDidFinish(this):setTimeout(()=>this.open(),l(100,100+(this.delegate.reconnectWindow||50)))},this.socket.onmessage=a=>{this.delegate.socketDidReceiveMessage(this,a.data)},this.delegate.socketDidOpen(this)}close(a,b){this.opening?(this.opening.abort(),this.opening=null):this.socket&&(this.socket.onclose=null,this.socket.close(a,b),this.socket=null,this.delegate.socketDidClose(this,a,b),this.delegate.socketDidFinish(this))}send(a){this.socket&&this.socket.send(a)}isOpen(){return!!this.socket}}function l(a,b){return Math.random()*(b-a)+a}function m(a){return a===n||a===o}let n=1008,o=1011}}])
//# sourceMappingURL=vendors-node_modules_github_alive-client_dist_index_js-node_modules_github_memoize_dist_esm_i-fab77c-0dcf8a62ff24.js.map